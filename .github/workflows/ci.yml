name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    php-lint-and-standards:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php: ['7.4', '8.2']

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  tools: composer
                  coverage: none

            - name: Setup Composer allow-plugins
              run: |
                  composer global config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true

            - name: Install PHPCS + WPCS (+ PHPCSExtra)
              shell: bash
              run: |
                  set -euo pipefail

                  # 1) Installa PHPCS + standards richiesti da WPCS 3.x
                  composer global require --no-interaction --no-progress \
                      squizlabs/php_codesniffer:^3.13 \
                      wp-coding-standards/wpcs:^3.0 \
                      phpcsstandards/phpcsextra:^1.4 \
                      phpcsstandards/phpcsutils:^1.1

                  # 2) Registra TUTTI i paths degli standard (WPCS + PHPCSExtra)
                  COMPOSER_HOME="$(composer global config home --absolute)"
                  PHPCS="${COMPOSER_HOME}/vendor/bin/phpcs"
                  WPCS_PATH="${COMPOSER_HOME}/vendor/wp-coding-standards/wpcs"
                  EXTRA_PATH="${COMPOSER_HOME}/vendor/phpcsstandards/phpcsextra"

                  "${PHPCS}" --config-set installed_paths "${WPCS_PATH},${EXTRA_PATH}"

            - name: Verify PHPCS standards (installed)
              shell: bash
              run: |
                  COMPOSER_HOME="$(composer global config home --absolute)"
                  PHPCS="${COMPOSER_HOME}/vendor/bin/phpcs"
                  "${PHPCS}" -i
                  "${PHPCS}" --version

            - name: PHP syntax lint (recursive)
              run: |
                  find . -type f -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 -P4 php -l

            - name: PHPCS (WordPress ruleset)
              run: |
                  COMPOSER_HOME="$(composer global config home --absolute)"
                  PHPCS="${COMPOSER_HOME}/vendor/bin/phpcs"
                  "${PHPCS}" -p \
                    --standard=WordPress \
                    --ignore=vendor/*,node_modules/* \
                    --extensions=php \
                    .
